name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    env:
      SECRET_KEY: ci-access-secret
      REFRESH_SECRET_KEY: ci-refresh-secret
      DATABASE_URL: sqlite+pysqlite:///:memory:
      CORS_ALLOW_ORIGINS: http://localhost
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/api/requirements.txt
          pip install ruff mypy
      - name: Install api-client deps
        run: npm ci
        working-directory: packages/api-client
      - name: Ruff
        run: ruff check apps/api
      - name: Mypy
        run: mypy apps/api/app
      - name: Pytest
        run: pytest apps/api/tests_smoke.py apps/api/tests_business.py apps/api/tests_integration.py
      - name: Verify generated api-client types
        run: npm run check:generated
        working-directory: packages/api-client

  frontend-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [apps/admin, apps/miniapp]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install
        run: npm ci
        working-directory: ${{ matrix.app }}
      - name: Lint
        run: npm run lint --if-present
        working-directory: ${{ matrix.app }}
      - name: Typecheck
        run: npm run typecheck --if-present
        working-directory: ${{ matrix.app }}
      - name: Tests
        run: npm run test --if-present
        working-directory: ${{ matrix.app }}
      - name: Build
        run: npm run build
        working-directory: ${{ matrix.app }}

  compose-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate compose configs
        run: |
          docker compose -f docker-compose.dev.yml --env-file .env.dev config > /tmp/dev-compose.txt
          docker compose -f docker-compose.prod.yml --env-file .env.prod config > /tmp/prod-compose.txt

  e2e-standalone:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install e2e deps
        run: npm ci
        working-directory: tests/e2e
      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium
        working-directory: tests/e2e
      - name: Run e2e tests
        run: npm test
        working-directory: tests/e2e

  docker-images:
    runs-on: ubuntu-latest
    needs:
      - backend
      - frontend-build
      - compose-config
      - e2e-standalone
    steps:
      - uses: actions/checkout@v4
      - name: Build API image
        run: docker build -f apps/api/Dockerfile -t adcontrol-api:ci apps/api
      - name: Build admin image
        run: docker build -f apps/admin/Dockerfile.prod --build-arg VITE_API_URL=/api/v1 -t adcontrol-admin:ci apps/admin
      - name: Build miniapp image
        run: docker build -f apps/miniapp/Dockerfile.prod --build-arg VITE_API_URL=/api/v1 -t adcontrol-miniapp:ci apps/miniapp
      - name: Build standalone image
        run: docker build -f frontend/Dockerfile -t adcontrol-standalone:ci frontend
